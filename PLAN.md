# Midas 开发计划

本文档为个人多模态知识库助手 Midas 的完整开发计划，与 [midas_request.md](./midas_request.md) 需求文档配套使用。

---

## 1. 范围与约束

### 1.1 当前阶段（基本开发）

- **目标**：在无 NVIDIA 显卡的机器上完成服务端与客户端的基本开发与联调。
- **ASR**：使用 CPU 运行语音转写（如 Whisper CPU 或较小模型），先打通「B 站链接 → 音频 → 转写 → LLM 总结」全链路。
- **CUDA/GPU**：不在本阶段实现，留待迁移到 4070 笔记本后再做。

### 1.2 设备迁移与移植性

- **配置驱动**：ASR 的设备（cpu / cuda）、模型类型/路径等均通过配置文件或环境变量指定，不在代码中写死。迁移到 4070 时仅修改配置即可。
- **接口统一**：ASR 层抽象为统一接口（输入音频 → 输出文本），内部按配置选择 CPU 或 CUDA 实现，后续切换实现时无需改动调用方。
- **依赖可选**：CUDA/GPU 相关依赖设为可选（如先使用 CPU 版 PyTorch），当前环境不安装 GPU 版也能完成开发与联调；在 4070 上再安装带 CUDA 的依赖并启用高精度模型。

---

## 2. 阶段总览

| 阶段 | 内容 | 说明 |
|------|------|------|
| 0 | 准备 | 环境与凭证（本机无 NV 显卡则跳过 CUDA） |
| 1 | 服务端骨架与配置 | 项目结构、配置文件、健康检查/连接测试接口 |
| 2 | B 站视频总结链路 | 音频下载 → ASR(CPU) → LLM → Markdown；预留 device/model 配置 |
| 3 | 小红书收藏夹同步 | 限流、去重、随机延迟、熔断、LLM 总结、SQLite |
| 4 | 服务端 API 与错误约定 | 统一 HTTP 接口与错误格式，便于客户端区分熔断/Cookie 失效等 |
| 5 | Android 客户端 | 配置、连接测试、B 站/小红书交互、Markdown 展示与错误提示 |
| 6 | 联调与收尾 | 局域网联调、README 与配置说明 |
| 7* | CUDA/高精度 ASR（后续） | 在 4070 本子上启用 GPU、大模型与高精度参数 |

\* 阶段 7 在迁移到 4070 笔记本后进行。

---

## 3. 各阶段说明

### 阶段 0：准备

- 本机：Python 3.10+、Android 开发环境（Android Studio 或命令行构建）。
- 无需在本机安装 CUDA；若使用 Whisper，先使用 CPU 或小模型。
- 准备：LLM API Key（如 DeepSeek/OpenAI）、小红书 Cookie 与目标收藏夹 ID（后续填入配置）。

### 阶段 1：服务端骨架与配置

- 建立 Python 项目结构，`requirements.txt` 管理依赖（GPU 相关为可选）。
- 配置文件（如 YAML）及加载逻辑：服务监听地址/端口、LLM（API Key、Base URL、Model）、ASR 相关参数（含 device、model 等，便于后续迁移）、小红书 Cookie 与收藏夹 ID。
- 提供健康检查或简单 HTTP 接口，供客户端「连接测试」使用。

### 阶段 2：B 站视频总结链路

- 输入：B 站视频链接。
- 使用成熟方案下载视频高质量音频（如 yt-dlp）。
- 本地 ASR：当前使用 **CPU**，接口设计为可切换设备与模型；配置项预留 `device`（如 cpu/cuda）、`model` 等。
- 调用 LLM 生成结构化 Markdown 笔记并返回；失败时返回明确错误信息。

### 阶段 3：小红书收藏夹同步

- 从配置读取 Cookie 与收藏夹 ID。
- 单次拉取有限条数最近笔记，解析正文与 ID。
- SQLite 记录已同步 ID，仅处理新笔记；请求间加入随机延迟；连续 N 次失败则熔断并写日志。
- 每条新笔记调用 LLM 总结，成功则落库；返回本次新增总结列表或熔断/错误提示。

### 阶段 4：服务端 API 与错误约定

- 定义并实现：B 站总结、小红书同步、连接测试等 HTTP 接口。
- 统一错误响应格式（如 JSON：code、message），使客户端能区分 Cookie 失效、熔断、网络错误等并给出对应提示。

### 阶段 5：Android 客户端

- **设置**：服务端 IP、端口，持久化；「连接测试」调用服务端并显示成功/失败。
- **B 站**：输入框 + 提交；请求中显示加载状态（如「正在高精度转录中，请耐心等待…」）；成功展示 Markdown，失败给出提示。
- **小红书**：「同步最近收藏」按钮；请求中显示进度（如「正在同步：第 x/y 篇…」）；熔断/Cookie 类错误时提示「Cookie 可能已失效，请检查服务端日志」。
- **结果区**：Markdown 渲染（标题、列表、代码块等）。

### 阶段 6：联调与收尾

- 在局域网内联调：客户端连接真实服务端，验证 B 站总结、小红书同步及各类错误场景。
- 编写 README：环境要求、配置项说明、服务端启动方式、Android 构建与安装、常见问题（Cookie 失效、熔断含义等）。

### 阶段 7（后续）：CUDA 与高精度 ASR

- **执行时机**：迁移到 4070 笔记本后。
- **内容**：在配置中启用 `device: cuda`，选用更大/高精度 ASR 模型，安装 CUDA 与对应依赖；不改变现有 API 与客户端，仅提升转写质量与速度。

---

## 4. 建议执行顺序

1. **阶段 1 → 阶段 2 → 阶段 4（B 站相关）**：先打通服务端 B 站整条链路并固化 API。
2. **阶段 5（B 站 + 连接测试 + 结果展示）**：客户端先不做小红书，只做配置、连接测试、B 站输入与 Markdown 展示。
3. **阶段 3 → 阶段 4（小红书接口）**：实现小红书同步逻辑并暴露同步 API。
4. **阶段 5（小红书区）**：客户端增加「同步最近收藏」与进度/熔断提示。
5. **阶段 6**：全流程联调与文档收尾。
6. **阶段 7**：在 4070 上按需启用 CUDA 与高精度模型。

---

## 5. 与需求文档的对应关系

- 功能与行为以 [midas_request.md](./midas_request.md) 为准。
- 本计划不改变需求，仅规定实现顺序与移植性要求；技术选型在满足需求与移植性前提下由实现方决定。
