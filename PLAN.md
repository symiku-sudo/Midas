# Midas 开发计划

本文档用于把需求文档落成可执行工程任务，与 [midas_request.md](./midas_request.md) 配套。

---

## 1. 开发目标与成功标准

### 1.1 本阶段目标（CPU 优先）

- 在无 NVIDIA 显卡环境下完成 MVP 全链路开发与联调。
- 打通两条核心流程：
  - B 站链接 -> 音频 -> ASR -> LLM -> Markdown。
  - 小红书收藏夹 -> 增量同步 -> LLM 总结 -> 结果返回。
- Android 端完成可用交互：配置、连接测试、触发任务、展示结果、提示错误。

### 1.2 迁移目标（4070 后续）

- 通过配置切换 `cpu/cuda` 与模型大小，不改 API、不改客户端协议。
- 在保持行为一致前提下提升转写质量与性能。

---

## 2. 技术路线（建议）

- 服务端：Python + FastAPI（或等价框架）。
- ASR：Whisper/Faster-Whisper，先 CPU，再切 GPU。
- B 站音频：`yt-dlp` + `ffmpeg`。
- 持久化：SQLite（记录已同步笔记、任务日志）。
- 客户端：Android（Kotlin + Retrofit/OkHttp + Markdown 渲染组件）。
- 配置：`yaml + .env`（敏感信息放 `.env`）。

说明：如已确定其他技术栈，可替换，但必须满足需求文档中的接口、错误与风控要求。

---

## 3. 阶段总览

| 阶段 | 目标 | 产出 |
|------|------|------|
| 0 | 环境准备 | 可运行开发环境、凭证与配置模板 |
| 1 | 服务端骨架 | 基础目录、配置加载、`/health` |
| 2 | B 站链路 | `summarize` 接口可用（CPU ASR） |
| 3 | 小红书链路 | `sync` 接口可用（限量/去重/延迟/熔断） |
| 4 | 协议固化 | 统一响应结构与错误码 |
| 5 | Android 客户端 | 可触发 B 站与小红书并展示结果 |
| 6 | 联调与发布准备 | README、配置说明、问题排查文档 |
| 7* | GPU 升级 | 启用 CUDA 与高精度模型 |

\* 阶段 7 在迁移到 4070 后执行。

---

## 4. 阶段执行细则（含 DoD）

### 阶段 0：环境准备

- 任务：
  - 安装 Python 3.10+、Android 构建环境、`ffmpeg`、`yt-dlp`。
  - 准备 `.env.example` 与 `config.example.yaml`。
  - 明确 LLM Key、Cookie、收藏夹 ID 来源与注入方式。
- DoD：
  - 新机器可按文档 30 分钟内启动开发环境。

### 阶段 1：服务端骨架与配置

- 任务：
  - 建立服务端目录（API、service、repo、model、config、utils）。
  - 实现配置加载与启动校验。
  - 实现 `GET /health`。
- DoD：
  - 服务端可启动，`/health` 返回成功。

### 阶段 2：B 站视频总结链路

- 任务：
  - 实现 `POST /api/bilibili/summarize`。
  - 音频下载、ASR（CPU）、LLM 总结串联。
  - 异常分类映射到统一错误码。
- DoD：
  - 对有效链接可返回 Markdown。
  - 对无效链接/下载失败/LLM 失败返回可区分错误码。

### 阶段 3：小红书收藏夹同步

- 任务：
  - 实现 `POST /api/xiaohongshu/sync`。
  - 实现限量拉取、SQLite 去重、随机延迟、连续失败熔断。
  - 输出同步统计（拉取/新增/失败/熔断）。
- DoD：
  - 连续两次同步时，第二次不重复处理已落库笔记。
  - Cookie 失效与熔断可通过错误码区分。

### 阶段 4：API 协议与错误码固化

- 任务：
  - 统一响应结构：`ok/code/message/data/request_id`。
  - 固化错误码文档与客户端映射文案。
  - 为关键接口补最小集成测试。
- DoD：
  - 客户端能稳定根据错误码渲染对应提示。

### 阶段 5：Android 客户端

- 任务：
  - 设置页：IP/端口保存与连接测试。
  - B 站页：输入、提交、加载状态、Markdown 展示。
  - 小红书页：同步按钮、进度显示、结果统计、错误提示。
- DoD：
  - 从手机可完整跑通两条主流程，不出现“静默失败”。

### 阶段 6：联调与收尾

- 任务：
  - 局域网真机联调与回归测试。
  - 补齐 README、部署与排障文档。
  - 整理已知限制与后续迭代列表。
- DoD：
  - 新用户按 README 能完成首次部署并成功执行一次 B 站总结与一次小红书同步。

### 阶段 7（后续）：CUDA 与高精度 ASR

- 任务：
  - 安装 CUDA 对应依赖，切换 `device: cuda`。
  - 使用更大模型并调整高精度参数。
  - 对比 CPU/GPU 质量与耗时。
- DoD：
  - API 与客户端无改动，GPU 模式稳定运行。

---

## 5. 测试与质量门槛

- 单元测试：
  - 配置解析、错误码映射、去重逻辑、熔断状态机。
- 集成测试：
  - `health/summarize/sync` 三个接口基础可用。
- 回归测试：
  - B 站正常/异常路径。
  - 小红书正常/Cookie 失效/限流熔断路径。
- 质量门槛：
  - 新增代码必须通过静态检查与最小测试集。
  - 不允许未分类异常直接透传给客户端。

---

## 6. 风险与应对

- 小红书接口变化或风控增强：
  - 通过限量、延迟、熔断和快速停机策略降低风险。
- LLM 服务波动：
  - 设置超时、重试上限与明确错误提示。
- 长音频处理耗时过长：
  - 客户端必须显示处理中状态，必要时支持异步任务模式（后续迭代）。
- 环境迁移复杂：
  - 配置驱动 + 可选依赖 + 环境文档模板。

---

## 7. 建议执行顺序

1. 阶段 0 -> 1 -> 2 -> 4：先固化 B 站链路与 API 协议。
2. 阶段 5（先做设置/B 站）：尽快形成可演示版本。
3. 阶段 3 -> 4：加入小红书链路并补全错误码。
4. 阶段 5（补小红书）-> 6：完成真机联调与文档收尾。
5. 阶段 7：迁移到 4070 后再做性能与精度升级。

---

## 8. 与需求文档关系

- 需求和验收以 [midas_request.md](./midas_request.md) 为准。
- 本计划不改变需求目标，仅把开发步骤、产出与完成标准具体化。
