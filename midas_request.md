# 产品需求文档：个人多模态知识库助手 Midas（High-Accuracy MVP）

## 1. 项目概述

开发一套 **Client-Server 架构** 的个人知识库系统。

- **服务端**：部署在具备本地算力的 PC（后续可切换 GPU），负责音视频处理、同步任务与 AI 推理。
- **客户端**：运行于 Android 设备，作为轻量交互界面，发起请求并展示结果。
- **核心目标**：准确性优先，确保 B 站转写质量与小红书同步安全性（降低风控风险）。

---

## 2. 范围定义

### 2.1 MVP 包含

- B 站单链接总结：音频获取、转写、LLM 结构化总结、Markdown 返回。
- 小红书收藏夹增量同步：限量拉取、去重、节奏控制、熔断、LLM 总结。
- Android 基础交互：服务地址配置、连接测试、任务触发、结果展示与错误提示。

### 2.2 MVP 不包含

- iOS/网页端客户端。
- 多用户账号体系与权限管理。
- 公网部署与跨地域访问。
- 自动登录小红书、验证码绕过等高风险行为。
- 向量检索、RAG、知识图谱等高级检索能力。

---

## 3. 约束与前提

### 3.1 运行环境

- 服务端与客户端通过局域网通信，不要求公网暴露。
- 小红书鉴权采用用户手动提供 Cookie，由服务端本地读取与使用。
- 客户端不存储、展示、上传 Cookie 明文。

### 3.2 依赖与前置条件

- 服务端可访问：B 站资源、所选 LLM 接口、小红书网页端接口。
- 用户自行准备：LLM API 凭证、小红书 Cookie、目标收藏夹标识。

---

## 4. 服务端功能需求

### 4.1 B 站视频总结（精度优先）

- **输入**：B 站视频链接（BV/av 或标准 URL）。
- **行为要求**：
  1. 获取高质量音频并完成语音转写，默认采用高精度参数（允许较长耗时）。
  2. 将转写文本交由 LLM 生成结构化 Markdown（摘要、要点、术语、可执行结论）。
  3. 对下载失败、转写失败、LLM 失败分别返回可识别错误码与错误信息。
- **输出**：包含 `video_url`、`summary_markdown`、`elapsed_ms`，失败时返回统一错误结构。

### 4.2 小红书收藏夹同步（风控与安全）

- **输入**：同步请求（可选 `limit`，默认值由服务端配置）。
- **配置依赖**：小红书 Cookie、收藏夹标识、本地数据库。
- **行为要求**：
  1. **数量限制**：单次仅拉取最近 N 条，默认建议 `N<=30`。
  2. **增量去重**：持久化笔记 ID，仅处理未同步笔记。
  3. **请求节奏**：处理多条笔记时加入随机延迟（建议 3-10 秒，可配置）。
  4. **异常熔断**：连续失败达到阈值（建议默认 3 次）立即停止本次同步并记录原因。
  5. **处理流程**：提取正文 -> LLM 总结 -> 成功落库。
- **输出**：返回新增总结列表与统计信息（拉取条数、新增条数、失败条数、是否熔断）。

### 4.3 配置与可运维性

- 支持配置文件或等价方式管理：监听地址端口、LLM 参数、ASR 参数、Cookie、收藏夹 ID、同步策略参数（N、延迟区间、熔断阈值）。
- 关键错误（鉴权失效、限流、熔断）必须有可追溯日志，建议带 `request_id`。
- 敏感信息（API Key、Cookie）不写入普通业务日志。

### 4.4 API 与错误约定（MVP 最小契约）

- **公共响应结构**：
  - 成功：`{ "ok": true, "code": "OK", "message": "", "data": {...}, "request_id": "..." }`
  - 失败：`{ "ok": false, "code": "...", "message": "...", "data": null, "request_id": "..." }`
- **最小接口**：
  - `GET /health`：连接测试。
  - `POST /api/bilibili/summarize`：B 站总结。
  - `POST /api/xiaohongshu/sync`：收藏夹同步。
- **建议错误码**：`INVALID_INPUT`、`AUTH_EXPIRED`、`RATE_LIMITED`、`CIRCUIT_OPEN`、`UPSTREAM_ERROR`、`INTERNAL_ERROR`。

---

## 5. 客户端功能需求（Android）

### 5.1 连接与设置

- 配置服务端 IP + 端口并本地持久化。
- 提供连接测试并展示结果与失败原因。

### 5.2 B 站总结

- 提供链接输入框与提交入口。
- 请求处理中显示明确状态（如“高精度转写中，请耐心等待”）。
- 成功展示 Markdown，失败展示可理解错误（优先使用错误码映射文案）。

### 5.3 小红书同步

- 提供单一入口触发同步。
- 展示进度（当前第 x/y 条）与最终统计。
- 当返回 `AUTH_EXPIRED`、`CIRCUIT_OPEN` 等错误时给出明确引导（检查 Cookie/查看服务端日志）。

### 5.4 结果展示

- 支持常见 Markdown 元素：标题、列表、引用、代码块、表格。

---

## 6. 非功能需求

- **准确性优先**：默认参数应偏向高精度转写而非低延迟。
- **耗时预期**：B 站总结允许分钟级完成；客户端不得无反馈等待。
- **错误可感知**：网络错误、服务错误、鉴权失效、熔断均需明确可区分。
- **安全与隐私**：Cookie 仅存在服务端可控环境，不经公网传输。
- **可迁移性**：ASR 设备与模型通过配置切换，迁移到 GPU 不应改 API。

---

## 7. 验收场景（示例）

| 场景 | 验收标准 |
|------|----------|
| B 站总结：有效链接 | 返回结构化 Markdown；客户端全程有状态提示。 |
| B 站总结：无效链接 | 返回 `INVALID_INPUT`；客户端显示可理解错误。 |
| B 站总结：LLM 暂时不可用 | 返回 `UPSTREAM_ERROR`；客户端不崩溃且可重试。 |
| 小红书同步：正常执行 | 仅处理新增笔记；返回统计信息与总结列表。 |
| 小红书同步：重复执行 | 已同步 ID 不重复处理，新增为 0 时可明确提示。 |
| 小红书同步：Cookie 失效 | 返回 `AUTH_EXPIRED`，服务端日志可定位失败原因。 |
| 小红书同步：连续失败触发熔断 | 同步立即停止并返回 `CIRCUIT_OPEN`。 |
| 连接测试：服务可达 | `/health` 返回成功。 |
| 连接测试：服务不可达 | 客户端显示连接失败与排查建议。 |

---

*本文档描述产品需求、边界与最小契约；技术选型与具体实现由实现方在满足上述要求前提下决定。*
